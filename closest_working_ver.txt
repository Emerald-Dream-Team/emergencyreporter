<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-Time Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    #messages {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }

    #messages li {
      margin-bottom: 10px;
    }

    #roleSelector {
      margin-bottom: 10px;
    }

    #broadcastInput,
    #broadcastButton,
    #clearMessagesButton {
      display: none;
    }

    #broadcastInput,
    #clearMessagesButton {
      margin-bottom: 10px;
    }

    #clearMessagesButton,
    #broadcastButton {
      margin-top: 10px;
      padding: 8px 16px;
      cursor: pointer;
      background-color: #4285f4;
      color: #ffffff;
      border: none;
      border-radius: 4px;
    }

    #clearMessagesButton:hover {
      background-color: #357ae8;
    }
  </style>
</head>
<body>
  <select id="roleSelector" onchange="setRole()">
    <option value="guest">Guest</option>
    <option value="admin">Admin</option>
  </select>

  <ul id="messages"></ul>

  <input id="broadcastInput" autocomplete="off" />
  <button id="broadcastButton" onclick="broadcastMessage()">Broadcast</button>

  <button id="clearMessagesButton" onclick="clearMessages()">Clear Messages</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script>
    const socket = io();
    let userRole = 'guest';

    // Load stored messages from localStorage
    const storedMessages = new Set(JSON.parse(localStorage.getItem('broadcastMessages'))) || new Set();

    socket.on('allMessages', (allMessages) => {
      // Display all stored messages when connecting
      displayStoredMessages(allMessages);
    });

    socket.on('broadcast', (data) => {
      // Check if the message with the given ID already exists to avoid duplication
      if (!storedMessages.has(data.id)) {
        storedMessages.add(data.id);

        // Display the message
        appendMessage(data.message);
      }
    });

    socket.on('messagesCleared', () => {
      // Clear the set of stored messages on the client side
      storedMessages.clear();

      // Clear the messages displayed on the page
      document.getElementById('messages').innerHTML = '';
    });

    function setRole() {
      const roleSelector = document.getElementById('roleSelector');
      userRole = roleSelector.value;

      // Show/hide elements based on user role
      toggleElementsVisibility();
      
      socket.emit('setRole', userRole);
    }

    function broadcastMessage() {
      const broadcastInput = document.getElementById('broadcastInput');
      const message = broadcastInput.value.trim();

      if (message !== '' && userRole === 'admin') {
        socket.emit('message', { message, role: userRole });
        broadcastInput.value = '';
      } else {
        alert('You enter a non-empty message to broadcast.');
      }
    }

    function appendMessage(message) {
      const messagesList = document.getElementById('messages');
      const li = document.createElement('li');
      li.appendChild(document.createTextNode(message));
      messagesList.appendChild(li);
    }

    function displayStoredMessages(messages) {
      const messagesList = document.getElementById('messages');
      messages.forEach((messageObj) => {
        // Display the message
        appendMessage(messageObj.message);

        // Add the message ID to the set to avoid duplicates
        storedMessages.add(messageObj.id);
      });
    }

    function clearMessages() {
      if (userRole === 'admin') {
        socket.emit('clearMessages');
      }
    }

    function toggleElementsVisibility() {
      const broadcastInput = document.getElementById('broadcastInput');
      const broadcastButton = document.getElementById('broadcastButton');
      const clearMessagesButton = document.getElementById('clearMessagesButton');

      if (userRole === 'admin') {
        // Show elements for admin
        broadcastInput.style.display = 'block';
        broadcastButton.style.display = 'block';
        clearMessagesButton.style.display = 'block';
      } else {
        // Hide elements for guest
        broadcastInput.style.display = 'none';
        broadcastButton.style.display = 'none';
        clearMessagesButton.style.display = 'none';
      }
    }
  </script>
</body>
</html>